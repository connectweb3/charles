<!doctype html><html lang="en"><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><title>Bison Defence</title><link rel="icon" type="image/png" href="favicon.png"><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="dns-prefetch" href="https://fonts.googleapis.com"><link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet"><style>:root{--primary:#00e5ff;--accent:#7c4dff;--danger:#ff3b6e;--success:#00ff95;--warning:#ffd166;--dark:#0a0f1c;--dark-2:#0f1730;--light:#e6f4ff;--glass:rgba(10, 15, 28, 0.35);--glass-strong:rgba(10, 15, 28, 0.6);--border:rgba(0, 229, 255, 0.45);--glow:0 0 22px rgba(0, 229, 255, 0.25),0 0 44px rgba(124, 77, 255, 0.18)}body{margin:0;overflow:hidden;background:radial-gradient(1200px 800px at 70% 10%,rgba(0,229,255,.06) 0,rgba(124,77,255,.05) 35%,rgba(10,15,28,0) 70%),linear-gradient(180deg,#060a16 0,#050913 50%,#02060f 100%);font-family:Orbitron,"Segoe UI",Tahoma,Geneva,Verdana,sans-serif;color:var(--light);user-select:none;-webkit-tap-highlight-color:transparent;position:relative}body::before{content:"";position:fixed;inset:0;background:radial-gradient(1500px 900px at 10% 20%,rgba(124,77,255,.06),transparent 60%),repeating-linear-gradient(90deg,rgba(255,255,255,.03) 0 1px,transparent 1px 80px),repeating-linear-gradient(0deg,rgba(255,255,255,.02) 0 1px,transparent 1px 80px);pointer-events:none;animation:slowPan 24s linear infinite;mix-blend-mode:screen;opacity:.6}@keyframes slowPan{0%{transform:translate3d(0,0,0)}100%{transform:translate3d(40px,20px,0)}}canvas{display:block;outline:0}.ui-layer{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;display:flex;flex-direction:column}.pointer-events-auto{pointer-events:auto}.hidden{display:none!important}button{background:linear-gradient(180deg,rgba(16,24,48,.65) 0,rgba(7,10,22,.75) 100%);color:var(--light);border:1px solid var(--border);padding:10px 20px;font-size:16px;border-radius:10px;cursor:pointer;transition:transform .15s ease,box-shadow .15s ease,background .15s ease,border-color .15s ease;font-weight:700;text-transform:uppercase;letter-spacing:.06em;box-shadow:inset 0 0 0 1px rgba(255,255,255,.06),var(--glow);touch-action:manipulation;backdrop-filter:blur(8px)}button:hover{border-color:var(--primary);box-shadow:inset 0 0 0 1px rgba(255,255,255,.08),0 0 18px rgba(0,229,255,.4),0 0 24px rgba(124,77,255,.28);transform:translateY(-1px) scale(1.02)}button:active{transform:translateY(2px) scale(.99);box-shadow:0 0 0 transparent}button:disabled{opacity:.5;cursor:not-allowed;border-color:#7f8c8d}button.upgrade-btn{display:flex;flex-direction:column;align-items:center;min-width:120px;font-size:12px;background:linear-gradient(180deg,rgba(18,26,56,.9) 0,rgba(7,10,22,.9) 100%)}button.upgrade-btn span.big{font-size:18px}button.danger{border-color:var(--danger);box-shadow:0 0 16px rgba(255,59,110,.28)}button.success{border-color:var(--success);background:linear-gradient(180deg,rgba(14,40,34,.75),rgba(6,22,18,.85))}#left-sidebar{position:absolute;top:140px;left:20px;display:flex;flex-direction:column;gap:12px;pointer-events:auto;z-index:2}#left-sidebar .sidebar-btn{display:inline-flex;align-items:center;justify-content:center;padding:10px 24px;font-size:16px;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:var(--light);text-decoration:none;background:linear-gradient(180deg,rgba(16,24,48,.65) 0,rgba(7,10,22,.75) 100%);border:1px solid var(--border);border-radius:10px;box-shadow:inset 0 0 0 1px rgba(255,255,255,.06),var(--glow);transition:transform .15s ease,box-shadow .15s ease,background .15s ease,border-color .15s ease}#left-sidebar .sidebar-btn:hover{border-color:var(--primary);box-shadow:inset 0 0 0 1px rgba(255,255,255,.08),0 0 18px rgba(0,229,255,.4),0 0 24px rgba(124,77,255,.28);transform:translateY(-1px) scale(1.02)}#left-sidebar .sidebar-btn:active{transform:translateY(2px) scale(.99);box-shadow:none}#hud-top{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;background:linear-gradient(to bottom,rgba(10,15,28,.75),rgba(10,15,28,.25) 60%,transparent);color:#fff;font-weight:700;text-shadow:0 0 8px rgba(0,0,0,.6);pointer-events:auto;gap:10px;flex-wrap:wrap;border-bottom:1px solid rgba(0,229,255,.25);box-shadow:0 8px 30px rgba(0,0,0,.35);backdrop-filter:blur(10px)}.stat-box{display:flex;align-items:center;gap:10px}#hp-bar-ctn{width:180px;height:16px;background:rgba(255,255,255,.06);border:1px solid rgba(0,229,255,.35);border-radius:20px;overflow:hidden;position:relative;box-shadow:inset 0 0 12px rgba(0,0,0,.6),0 0 18px rgba(0,229,255,.2)}#hp-bar-fill{height:100%;background:linear-gradient(90deg,#00ff95 0,#00e5ff 100%);width:100%;transition:width .2s ease;position:relative}#hp-bar-fill::after{content:"";position:absolute;inset:0;background:repeating-linear-gradient(-45deg,rgba(255,255,255,.18) 0 6px,transparent 6px 12px);mix-blend-mode:overlay;opacity:.25;animation:shimmer 2.2s linear infinite}#hp-text{position:absolute;width:100%;text-align:center;top:-2px;font-size:12px;line-height:16px;text-shadow:0 0 6px rgba(0,0,0,.9)}#xp-bar-ctn{width:180px;height:10px;background:rgba(255,255,255,.06);border:1px solid rgba(124,77,255,.45);border-radius:20px;overflow:hidden;position:relative;box-shadow:inset 0 0 10px rgba(0,0,0,.6),0 0 16px rgba(124,77,255,.25)}#xp-bar-fill{height:100%;background:linear-gradient(90deg,#7c4dff,#00e5ff);width:0%;transition:width .2s ease;position:relative}#xp-bar-fill::after{content:"";position:absolute;inset:0;background:repeating-linear-gradient(-45deg,rgba(255,255,255,.12) 0 5px,transparent 5px 10px);opacity:.28;animation:shimmer 2.4s linear infinite reverse}#xp-text{position:absolute;width:100%;text-align:center;top:-2px;font-size:10px;line-height:10px;color:#ecf0f1;text-shadow:0 0 6px rgba(0,0,0,.9)}#gold-display{color:var(--warning);font-size:20px;text-shadow:0 0 8px rgba(255,209,102,.45)}#hud-bottom{margin-top:auto;padding:12px;display:flex;gap:12px;justify-content:center;flex-wrap:wrap;background:linear-gradient(to top,rgba(10,15,28,.85),rgba(10,15,28,.2) 60%,transparent);pointer-events:auto;border-top:1px solid rgba(0,229,255,.25);box-shadow:0 -10px 30px rgba(0,0,0,.35);backdrop-filter:blur(10px)}#wave-ctrl{position:absolute;top:60px;width:100%;text-align:center;pointer-events:none}#start-wave-btn{pointer-events:auto;padding:10px 30px;font-size:20px;animation:glowPulse 2s infinite;border-color:var(--success)}.overlay{position:absolute;top:0;left:0;width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;color:#fff;z-index:100;pointer-events:auto;background:radial-gradient(900px 600px at 50% 20%,rgba(0,229,255,.12),rgba(124,77,255,.1) 40%,rgba(0,0,0,.85) 80%);backdrop-filter:blur(8px)}.overlay::before{content:"";position:absolute;inset:0;pointer-events:none;background:repeating-linear-gradient(0deg,rgba(255,255,255,.05) 0 1px,transparent 1px 3px);mix-blend-mode:soft-light;animation:scan 6s linear infinite}.overlay::after{content:"";position:absolute;inset:0;pointer-events:none;background:radial-gradient(800px 500px at 50% 20%,rgba(0,229,255,.06),transparent 60%);filter:blur(10px)}.overlay h1{font-size:4rem;margin:0 0 20px 0;text-transform:uppercase;letter-spacing:8px;background:linear-gradient(90deg,#00e5ff,#7c4dff);-webkit-background-clip:text;background-clip:text;color:transparent;text-shadow:0 0 32px rgba(0,229,255,.35)}.overlay p{font-size:1.2rem;margin-bottom:30px;color:#bdc3c7;text-align:center;max-width:80%;text-shadow:0 0 6px rgba(0,0,0,.7)}.title-screen h1{filter:drop-shadow(0 0 20px rgba(0, 229, 255, .35))}.victory-screen h1{background:linear-gradient(90deg,#ffd166,#00e5ff);-webkit-background-clip:text;background-clip:text}.defeat-screen h1{background:linear-gradient(90deg,#ff3b6e,#7c4dff);-webkit-background-clip:text;background-clip:text}#start-logo{width:360px;max-width:70vw;height:auto;margin-bottom:20px;filter:drop-shadow(0 0 25px rgba(0, 229, 255, .35)) drop-shadow(0 0 40px rgba(124, 77, 255, .25))}#preload-logo{width:160px;height:auto;margin-bottom:20px;filter:drop-shadow(0 0 18px rgba(0, 229, 255, .28))}#preload-progress{width:60%;max-width:520px;height:14px;border:1px solid rgba(255,255,255,.7);border-radius:10px;overflow:hidden;margin-top:10px;background:rgba(255,255,255,.08);box-shadow:inset 0 0 10px rgba(0,0,0,.6),0 0 20px rgba(0,229,255,.25)}#preload-bar{height:100%;width:0%;background:linear-gradient(90deg,#00e5ff,#7c4dff);transition:width .2s ease;box-shadow:0 0 18px var(--primary),0 0 28px rgba(124,77,255,.4);position:relative}#preload-bar::after{content:"";position:absolute;inset:0;background:linear-gradient(90deg,transparent 0,rgba(255,255,255,.35) 50%,transparent 100%);mix-blend-mode:screen;animation:shimmer 2s linear infinite}#preload-text{margin-top:10px}.settings-row{display:flex;gap:12px;margin-top:22px;align-items:center}.toggle-switch{display:flex;border:1px solid rgba(255,255,255,.25);border-radius:10px;overflow:hidden;cursor:pointer;background:rgba(255,255,255,.06);backdrop-filter:blur(6px)}.toggle-opt{padding:6px 12px;background:0 0;font-size:12px;color:#bcd2ff}.toggle-opt.active{background:linear-gradient(180deg,rgba(0,229,255,.25),rgba(124,77,255,.2));color:#fff;text-shadow:0 0 8px rgba(0,229,255,.5)}.verification-panel{width:100%;max-width:520px;margin:0 auto 24px auto;padding:20px 24px;background:linear-gradient(180deg,rgba(8,13,28,.8),rgba(6,10,22,.95));border:1px solid rgba(0,229,255,.25);border-radius:14px;box-shadow:inset 0 0 0 1px rgba(255,255,255,.05),0 12px 30px rgba(0,0,0,.45);backdrop-filter:blur(10px)}.verification-panel h2{margin:0 0 12px 0;font-size:20px;letter-spacing:2px;color:var(--primary);text-transform:uppercase}.verification-panel label{display:block;font-size:13px;text-transform:uppercase;letter-spacing:1.5px;color:#9cb8ff;margin-bottom:8px}.verification-input-row{display:flex;gap:10px;align-items:center}.verification-input-row input{flex:1;padding:12px 14px;border-radius:10px;border:1px solid rgba(0,229,255,.35);background:rgba(10,15,28,.8);color:var(--light);font-family:inherit;font-size:14px;letter-spacing:.05em;outline:0;box-shadow:inset 0 0 12px rgba(0,0,0,.6)}.verification-input-row input::placeholder{color:rgba(230,244,255,.45)}.verification-input-row button{padding:12px 16px;white-space:nowrap}#wallet-feedback{margin-top:12px;font-size:13px;min-height:18px;color:#bcd2ff;letter-spacing:.04em}#wallet-feedback.success{color:var(--success)}#wallet-feedback.error{color:var(--danger)}#wallet-feedback.pending{color:var(--warning)}#wallet-buff{margin-top:8px;font-size:14px;color:var(--success);letter-spacing:.05em}.ranking-panel{width:100%;max-width:520px;margin:24px auto 0 auto;padding:18px 22px;background:linear-gradient(180deg,rgba(8,13,28,.75),rgba(6,10,22,.9));border:1px solid rgba(0,229,255,.18);border-radius:14px;box-shadow:inset 0 0 0 1px rgba(255,255,255,.04),0 10px 25px rgba(0,0,0,.35);backdrop-filter:blur(10px)}.ranking-header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px}.ranking-header h2{margin:0;font-size:18px;letter-spacing:2px;color:var(--primary);text-transform:uppercase}#ranking-refresh{font-size:12px;padding:6px 12px}.ranking-status{font-size:12px;letter-spacing:.08em;color:#9cb8ff;margin-bottom:10px;text-transform:uppercase}.ranking-status.error{color:var(--danger)}.ranking-list{list-style:none;margin:0;padding:0;display:flex;flex-direction:column;gap:6px}.ranking-entry{display:grid;grid-template-columns:50px 1fr 80px;align-items:center;gap:10px;padding:8px 12px;border:1px solid rgba(0,229,255,.25);border-radius:10px;background:rgba(10,15,28,.6);box-shadow:inset 0 0 12px rgba(0,0,0,.45);font-size:13px;letter-spacing:.04em}.ranking-entry.self{border-color:var(--success);box-shadow:0 0 20px rgba(0,255,149,.25),inset 0 0 12px rgba(0,0,0,.45)}.ranking-entry .pos{color:var(--warning);font-weight:700;text-align:left}.ranking-entry .addr{overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:#e6f4ff}.ranking-entry .time{text-align:right;font-weight:700;color:var(--success)}.ranking-placeholder{padding:10px 0;text-align:center;color:#9cb8ff;font-size:12px;letter-spacing:.06em}#ranking-note{margin-top:12px;font-size:12px;letter-spacing:.06em;color:#9cb8ff;text-transform:uppercase;text-align:center}#powerup-options{display:flex;gap:14px;flex-wrap:wrap;justify-content:center}.powerup-btn{min-width:200px;max-width:260px;border-color:#8e44ad;background:linear-gradient(180deg,rgba(28,28,58,.9),rgba(16,16,38,.95));box-shadow:inset 0 0 0 1px rgba(255,255,255,.06),0 0 18px rgba(124,77,255,.25)}.powerup-btn .title{font-size:16px}.powerup-btn .desc{font-size:12px;opacity:.9}.floating-text{position:absolute;color:#e6f4ff;font-weight:700;font-size:20px;text-shadow:0 0 10px rgba(0,229,255,.5),0 0 16px rgba(124,77,255,.35);pointer-events:none;will-change:transform,opacity;animation:floatUp .8s forwards ease-out;z-index:50}.crit{color:var(--warning);font-size:28px;text-shadow:0 0 14px rgba(255,209,102,.7)}@keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.05);box-shadow:0 0 15px var(--success)}100%{transform:scale(1)}}@keyframes glowPulse{0%,100%{box-shadow:0 0 14px rgba(0,229,255,.35),0 0 24px rgba(124,77,255,.2)}50%{box-shadow:0 0 24px rgba(0,229,255,.6),0 0 38px rgba(124,77,255,.35)}}@keyframes shimmer{0%{background-position:0 0}100%{background-position:120px 0}}@keyframes scan{0%{transform:translateY(-10%)}100%{transform:translateY(10%)}}@keyframes floatUp{0%{opacity:1;transform:translate(-50%,0) scale(.5)}20%{transform:translate(-50%,-20px) scale(1.2)}100%{opacity:0;transform:translate(-50%,-60px) scale(1)}}@media (max-width:600px){#hud-top{font-size:12px;flex-wrap:wrap}#hp-bar-ctn{width:120px}#xp-bar-ctn{width:120px}button.upgrade-btn{min-width:90px;padding:6px}button.upgrade-btn span.big{font-size:14px}#left-sidebar{position:static;align-items:center;margin:10px auto 0;left:auto;top:auto;gap:8px}#left-sidebar .sidebar-btn{width:100%;max-width:220px}.overlay h1{font-size:2.5rem}}</style><script type="importmap">{
      "imports": {
        "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
        "gsap": "https://unpkg.com/gsap@3.12.4/index.js",
        "@supabase/supabase-js": "https://esm.sh/@supabase/supabase-js@2"
      }
    }</script><div id="game-container"></div><div id="floating-text-layer" class="ui-layer"></div><div id="hud" class="ui-layer hidden"><div id="hud-top"><div class="stat-box"><div id="hp-bar-ctn"><div id="hp-bar-fill"></div><span id="hp-text">100/100</span></div></div><div class="stat-box"><div id="xp-bar-ctn"><div id="xp-bar-fill"></div><span id="xp-text">0/20</span></div><span>Lvl: <span id="level-num">1</span></span></div><div class="stat-box">Time: <span id="time-display">00:00</span></div><div class="stat-box">Diff: <span id="diff-display">1.0x</span></div><div class="stat-box">Buff: <span id="buff-display">+0%</span></div><div class="stat-box">Enemies: <span id="enemy-count">0</span></div><div class="stat-box">üí∞ <span id="gold-display">0</span></div><div class="stat-box"><button id="btn-pause" style="padding:2px 8px">II</button> <button id="btn-mute" style="padding:2px 8px">üîä</button></div></div><div id="left-sidebar" class="pointer-events-auto"><a id="buy-nft-link" class="sidebar-btn" href="https://www.jpg.store/collection/bisonislands?tab=minting" target="_blank" rel="noopener">Buy NFT</a></div><div id="hud-bottom"><button id="btn-upg-dmg" class="upgrade-btn pointer-events-auto"><span>‚öîÔ∏è DMG Lv.<span id="dmg-lvl">1</span></span> <span class="big" id="dmg-cost">50g</span></button> <button id="btn-upg-hp" class="upgrade-btn pointer-events-auto"><span>‚ù§Ô∏è Max HP Lv.<span id="hp-lvl">1</span></span> <span class="big" id="hp-cost">50g</span></button> <button id="btn-repair" class="upgrade-btn pointer-events-auto" style="border-color:var(--success)"><span>‚ûï Repair</span> <span class="big" id="repair-cost">20g</span></button></div></div><div id="wave-ctrl"><button id="start-wave-btn" class="pointer-events-auto hidden">Start Wave</button></div><div id="preload-screen" class="overlay pointer-events-auto"><img id="preload-logo" src="logo.png" alt="Loading Logo"><div id="preload-progress"><div id="preload-bar"></div></div><p id="preload-text">Loading... 0%</div><div id="start-screen" class="overlay title-screen pointer-events-auto hidden"><img id="start-logo" src="bison.png" alt="Bison Defence"><p>Survive as long as you can as enemies scale up over time.<br>Upgrade your firepower and fortifications.<div class="verification-panel pointer-events-auto"><h2>Access Verification</h2><label for="wallet-input">Cardano wallet or stake address</label><div class="verification-input-row"><input id="wallet-input" placeholder="addr1... or stake1..." autocomplete="off" spellcheck="false"> <button id="btn-verify" type="button" class="pointer-events-auto success">Verify</button></div><div id="wallet-feedback">Enter your address to unlock buffs and leaderboard ranking.</div><div id="wallet-buff" class="hidden">Damage buff: +0%</div></div><p id="best-time" style="margin-top:8px">Best: 00:00<div id="ranking-panel" class="ranking-panel pointer-events-auto"><div class="ranking-header"><h2>Top Survivors</h2><button id="ranking-refresh" type="button" class="pointer-events-auto">Refresh</button></div><div id="ranking-status" class="ranking-status">Loading leaderboard...</div><ul id="ranking-list" class="ranking-list"></ul><div id="ranking-note">Verify an address to join the leaderboard.</div></div><button id="btn-play" style="font-size:24px;padding:15px 40px" class="success" disabled="disabled">PLAY</button><div class="settings-row"><span>Graphics:</span><div class="toggle-switch" id="quality-toggle"><div class="toggle-opt" data-q="low">Low</div><div class="toggle-opt active" data-q="high">High</div></div></div></div><div id="pause-screen" class="overlay hidden pointer-events-auto"><h1>PAUSED</h1><button id="btn-resume" class="success" style="margin-bottom:10px">RESUME</button> <button id="btn-restart-pause" class="danger">RESTART</button></div><div id="levelup-screen" class="overlay hidden pointer-events-auto"><h1 style="color:#8e44ad;-webkit-text-fill-color:initial">LEVEL UP</h1><p>Choose a power-up<div id="powerup-options"></div></div><div id="gameover-screen" class="overlay hidden pointer-events-auto"><h1 id="go-title">DEFEAT</h1><p id="go-stats">You survived 00:00.</p><button id="btn-restart" class="success" style="font-size:24px">PLAY AGAIN</button></div><script type="module">import*as THREE from"three";import{OrbitControls}from"three/addons/controls/OrbitControls.js";import{EffectComposer}from"three/addons/postprocessing/EffectComposer.js";import{RenderPass}from"three/addons/postprocessing/RenderPass.js";import{UnrealBloomPass}from"three/addons/postprocessing/UnrealBloomPass.js";import{GLTFLoader}from"three/addons/loaders/GLTFLoader.js";import gsap from"gsap";import{createClient}from"@supabase/supabase-js";const loadingManager=new THREE.LoadingManager,textureLoader=new THREE.TextureLoader(loadingManager),gltfLoader=new GLTFLoader(loadingManager),C={TOTAL_WAVES:10,BASE_GOLD:60,CASTLE_HP_BASE:100,CASTLE_DMG_BASE:10,CASTLE_RANGE:12,CASTLE_FIRE_RATE:.5,PROJ_SPEED:25,LASER_COOLDOWN:2,LASER_DURATION:3,LASER_DMG_MULT:1.4,BOOMERANG_SPEED:14,BOOMERANG_MAX_DIST:12,BOOMERANG_COOLDOWN:1.6,BOOMERANG_HIT_RADIUS:.7,BOOMERANG_PIERCE:3,DRONE_ORBIT_RADIUS:4,DRONE_ORBIT_SPEED:1.2,DRONE_RANGE:10,DRONE_FIRE_COOLDOWN:1,AURA_DMG_MULT:.3,BLADE_ORBIT_RADIUS:3.5,BLADE_ORBIT_SPEED:2.8,BLADE_TICK:.15,BLADE_HIT_RADIUS:1.1,BLADE_DMG_MULT:.45,METEOR_COOLDOWN:3.8,METEOR_SPEED:18,METEOR_DMG_MULT:2.4,METEOR_RADIUS:2.8,METEOR_START_HEIGHT:14,METEOR_TRAIL_INTERVAL:.08,LIGHTNING_COOLDOWN:5,LIGHTNING_DMG_MULT:1.2,LIGHTNING_LINGER:.25,LIGHTNING_SPLASH_RADIUS:1.5,ICE_COOLDOWN:3.2,ICE_SPEED:32,ICE_DMG_MULT:1.1,ICE_FREEZE_TIME:1,ICE_RANGE:14,UPG_COST_BASE:50,UPG_SCALE:1.6,REPAIR_COST_PER_HP:1,COLORS:{castle:3447003,castleHurt:15158332,ground:2899536,path:3426654,enemy1:15158332,enemy2:15844367,enemy3:10181046,proj:3066993,projLight:9109429,blade:16753723,meteor:16739116,ice:8579583}},XP={base:20,growth:1.3,xpForLevel:e=>Math.floor(XP.base*Math.pow(XP.growth,Math.max(0,e-1)))},State={gold:0,timeSurvived:0,hp:0,maxHp:0,dmgLvl:1,hpLvl:1,damage:0,status:"start",enemiesAlive:0,muted:"true"===localStorage.getItem("cg_muted"),quality:localStorage.getItem("cg_quality")||"high",bestTime:parseFloat(localStorage.getItem("cg_best_time")||"0"),level:1,xp:0,xpToNext:XP.xpForLevel(1),dmgMult:1,fireRateMult:1,rangeMult:1,projSpeedMult:1,hpMult:1,multiShot:0,explosiveRadius:0,chainTargets:0,laserCount:0,boomerangCount:0,droneCount:0,bladeCount:0,meteorCount:0,lightningCount:0,iceCount:0,nftCount:0,nftDamageMultiplier:1,verifiedAddress:null,verifiedAddressType:null,verifiedStakeAddress:null,verifiedWalletAddress:null,powerLevels:{},auraActive:!1,auraRadius:4,auraTickInterval:.5,auraTimer:0};let scene,camera,renderer,composer,controls,castle,healthBarMesh,clock=new THREE.Clock;const tmpVec=new THREE.Vector3,tmpVec2=new THREE.Vector3,UNIT_Y=new THREE.Vector3(0,1,0),pools={enemies:[],projectiles:[],particles:[],lasers:[],boomerangs:[],drones:[],blades:[],meteors:[],lightning:[],ice:[]},active={enemies:[],projectiles:[],particles:[],lasers:[],boomerangs:[],drones:[],blades:[],meteors:[],lightning:[],ice:[]},BLOCKFROST_API_BASE="https://cardano-mainnet.blockfrost.io/api/v0",BLOCKFROST_PROJECT_ID="mainneteJV1JebLx0eqrIQYY3eYEQeGqIWvOpCF",TARGET_POLICY_ID="584af8907c477e897ec19a1bbf34a6bb462ab8adbf51252eb11ce083".toLowerCase(),BLOCKFROST_PAGE_SIZE=100,SUPABASE_URL="https://rsbxfxirkiwfojhmyotx.supabase.co",SUPABASE_ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJzYnhmeGlya2l3Zm9qaG15b3R4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIwOTcyNzIsImV4cCI6MjA3NzY3MzI3Mn0.U3EU-XFlYiTUWFHNzWW7926jj5d3MgnaCZUVMMdc-J0",RANKINGS_TABLE="rankings",SupabaseClient=createClient(SUPABASE_URL,SUPABASE_ANON_KEY,{auth:{persistSession:!1}}),RankingBoard={client:SupabaseClient,listEl:document.getElementById("ranking-list"),statusEl:document.getElementById("ranking-status"),noteEl:document.getElementById("ranking-note"),refreshBtn:document.getElementById("ranking-refresh"),lastData:[],lastFetched:0,activeStake:null,isRefreshing:!1,init(){this.listEl&&(this.refreshBtn&&this.refreshBtn.addEventListener("click",()=>this.refresh(!0)),this.updateNote(),this.refresh(!0))},updateNote(){this.noteEl&&(this.noteEl.textContent=this.activeStake?"Your verified runs will be highlighted.":"Verify an address to join the leaderboard.")},setStatus(e,t){this.statusEl&&(this.statusEl.textContent=e,this.statusEl.classList.remove("error"),t&&this.statusEl.classList.add(t))},formatDuration(e){const t=Math.max(0,Math.floor(Number.isFinite(e)?e:0)),a=Math.floor(t/60),s=t%60;return`${String(a).padStart(2,"0")}:${String(s).padStart(2,"0")}`},formatAddress:e=>e&&"string"==typeof e?e.length<=12?e:`${e.slice(0,6)}...${e.slice(-4)}`:"Unknown",markActiveEntries(){this.listEl&&this.listEl.querySelectorAll("[data-stake]").forEach(e=>{e.classList.toggle("self",!!this.activeStake&&e.dataset.stake===this.activeStake)})},setActiveStake(e){this.activeStake=e||null,this.markActiveEntries(),this.updateNote()},async refresh(e=!1){if(!this.client||!this.listEl||this.isRefreshing)return;const t=Date.now();if(e||!(t-this.lastFetched<5e3)){this.isRefreshing=!0,this.setStatus("Loading leaderboard...",null),this.listEl.innerHTML="";try{const{data:e,error:t}=await this.client.from("rankings").select("stake_address,wallet_address,best_time").order("best_time",{ascending:!1}).limit(10);if(t)throw t;const a=Array.isArray(e)?e.map(e=>{const t=Number(e?.best_time);return Number.isFinite(t)?{...e,best_time:t}:null}).filter(Boolean):[];this.lastData=a,this.render(a),this.setStatus(a.length?"Top Survivors":"No ranked runs yet. Be the first!",null),this.markActiveEntries()}catch(e){console.error("Leaderboard fetch failed",e),this.setStatus("Unable to load leaderboard. Try again later.","error"),this.listEl.innerHTML=""}finally{this.isRefreshing=!1,this.lastFetched=t}}},render(e){if(this.listEl){if(this.listEl.innerHTML="",!e.length){const e=document.createElement("li");return e.className="ranking-placeholder",e.textContent="Leaderboard empty.",void this.listEl.appendChild(e)}e.forEach((e,t)=>{const a=document.createElement("li");a.className="ranking-entry",a.dataset.stake=e.stake_address||"";const s=document.createElement("span");s.className="pos",s.textContent=`#${t+1}`;const i=document.createElement("span");i.className="addr",i.textContent=this.formatAddress(e.wallet_address||e.stake_address||"");const o=document.createElement("span");o.className="time",o.textContent=this.formatDuration(e.best_time),a.appendChild(s),a.appendChild(i),a.appendChild(o),this.listEl.appendChild(a)})}},async submitScore(e){if(!this.client)return;const t=State?.verifiedStakeAddress;if(t&&Number.isFinite(e)&&!(e<=0))try{const{data:a,error:s}=await this.client.from("rankings").select("best_time,wallet_address").eq("stake_address",t).maybeSingle();if(s)throw s;const i=State.verifiedWalletAddress||null;if(!a){const{error:a}=await this.client.from("rankings").insert({stake_address:t,wallet_address:i,best_time:e});if(a)throw a;return void this.refresh(!0)}if(e>(Number(a.best_time)||0)){const s={best_time:e};i&&i!==a.wallet_address&&(s.wallet_address=i);const{error:o}=await this.client.from("rankings").update(s).eq("stake_address",t);if(o)throw o;this.refresh(!0)}}catch(e){console.error("Leaderboard submit failed",e),this.setStatus("Could not submit score.","error")}}},AccessGate={input:document.getElementById("wallet-input"),feedback:document.getElementById("wallet-feedback"),buffEl:document.getElementById("wallet-buff"),verifyBtn:document.getElementById("btn-verify"),playBtn:document.getElementById("btn-play"),currentRequest:0,init(){this.input&&this.verifyBtn&&this.playBtn&&(this.verifyBtn.dataset.label||(this.verifyBtn.dataset.label=this.verifyBtn.textContent),this.playBtn.disabled=!1,this.clearBuff(),this.setStatus("Verify an address to unlock buffs and leaderboard ranking."),this.verifyBtn.addEventListener("click",()=>this.verify()),this.input.addEventListener("keydown",e=>{"Enter"===e.key&&(e.preventDefault(),this.verify())}),this.input.addEventListener("input",()=>{this.currentRequest++,this.buffEl&&this.buffEl.classList.add("hidden"),this.clearBuff(),this.setStatus("Verify an address to unlock buffs and leaderboard ranking."),this.verifyBtn.disabled=!1,this.verifyBtn.textContent=this.verifyBtn.dataset.label||"Verify"}))},setStatus(e,t){this.feedback&&(this.feedback.textContent=e,this.feedback.classList.remove("success","error","pending"),t&&this.feedback.classList.add(t))},clearBuff(){State.nftCount=0,State.nftDamageMultiplier=1,State.verifiedAddress=null,State.verifiedAddressType=null,State.verifiedStakeAddress=null,State.verifiedWalletAddress=null,void 0!==UI&&UI.updateHUD&&UI.updateHUD(),RankingBoard.setActiveStake(null)},async verify(){const e=(this.input?.value||"").trim(),t=++this.currentRequest;if(this.buffEl&&this.buffEl.classList.add("hidden"),this.clearBuff(),!e)return this.setStatus("Playing without verification. Leaderboard submissions require an address."),this.playBtn.disabled=!1,void(void 0!==UI&&UI.updateHUD&&UI.updateHUD());const a=e.toLowerCase();let s;if(a.startsWith("stake"))s="stake";else{if(!a.startsWith("addr"))return void this.setStatus("Address must start with addr1 or stake1.","error");s="addr"}let i=e,o=null;const r=s;if("addr"===s)try{if(o=await this.resolveStakeAddress(e,t),t!==this.currentRequest)return;if(!o)throw new Error("That wallet could not be linked to a stake address.");i=o,s="stake",this.setStatus("Wallet resolved to stake address. Checking ownership...","pending")}catch(e){if(t!==this.currentRequest)return;const a=e&&e.message?e.message:"Unable to resolve stake address for that wallet.";return void this.setStatus(a,"error")}this.verifyBtn&&(this.verifyBtn.disabled=!0,this.verifyBtn.dataset.label||(this.verifyBtn.dataset.label=this.verifyBtn.textContent),this.verifyBtn.textContent="Checking..."),this.setStatus("Checking ownership on-chain...","pending");try{const a=await this.fetchAssetCount(i,s,t);if(t!==this.currentRequest)return;a>0?this.setStatus(`Verified! ${a} NFT${a>1?"s":""} detected.`,"success"):this.setStatus("No Bison Island NFTs detected. You can still play without a buff."),this.applyBuff({count:a,queryIdentifier:i,mode:s,originalInput:e,originalMode:r,resolvedStake:o})}catch(e){if(t!==this.currentRequest)return;if(e&&"cancelled"===e.message)return;const a=e&&e.message?e.message:"Verification failed. Please try again.";this.setStatus(a,"error")}finally{t===this.currentRequest&&this.playBtn&&(this.playBtn.disabled=!1),t===this.currentRequest&&this.verifyBtn&&(this.verifyBtn.disabled=!1,this.verifyBtn.textContent=this.verifyBtn.dataset.label||"Verify")}},async resolveStakeAddress(e,t){const a=await fetch(`${BLOCKFROST_API_BASE}/addresses/${e}`,{headers:{project_id:BLOCKFROST_PROJECT_ID,Accept:"application/json"}});if(t!==this.currentRequest)throw new Error("cancelled");let s=null;try{s=await a.json()}catch{s=null}if(!a.ok){if(404===a.status)throw new Error("Blockfrost could not find that wallet address.");const e=s&&s.message?s.message:`Blockfrost error (${a.status})`;throw new Error(e)}if(!s||!s.stake_address)throw new Error("That wallet address is not associated with a stake key.");return s.stake_address},async fetchAssetCount(e,t,a){const s="stake"===t?`${BLOCKFROST_API_BASE}/accounts/${e}/addresses/assets`:`${BLOCKFROST_API_BASE}/addresses/${e}/assets`;let i=0;for(let e=1;e<=10;e++){if(a!==this.currentRequest)throw new Error("cancelled");const o=await fetch(`${s}?page=${e}&count=100`,{headers:{project_id:BLOCKFROST_PROJECT_ID,Accept:"application/json"}});if(a!==this.currentRequest)throw new Error("cancelled");if(404===o.status)throw new Error(`Blockfrost could not find that ${"stake"===t?"stake address":"wallet address"}.`);let r=null;try{r=await o.json()}catch{r=null}if(!o.ok){const e=r&&r.message?r.message:`Blockfrost error (${o.status})`;throw new Error(e)}if(!Array.isArray(r)||0===r.length)break;for(const e of r)if(e&&"string"==typeof e.unit&&e.unit.toLowerCase().startsWith(TARGET_POLICY_ID))try{const t=Number(BigInt(e.quantity));Number.isFinite(t)&&(i+=t)}catch{const t=parseInt(e.quantity,10);Number.isNaN(t)||(i+=t)}if(r.length<100)break}return i},applyBuff({count:e,queryIdentifier:t,mode:a,originalInput:s,originalMode:i,resolvedStake:o}){const r=Math.max(0,Number.isFinite(e)?Math.floor(e):0);r>0?(State.nftCount=r,State.nftDamageMultiplier=1+r/100,this.buffEl&&(this.buffEl.textContent=`Damage buff: +${r}%`,this.buffEl.classList.remove("hidden"))):(State.nftCount=0,State.nftDamageMultiplier=1,this.buffEl&&(this.buffEl.textContent="Damage buff: +0%",this.buffEl.classList.add("hidden"))),State.verifiedAddress=t,State.verifiedAddressType=a,State.verifiedStakeAddress="stake"===a?t:o||null,State.verifiedWalletAddress="addr"===i?s:null,RankingBoard.setActiveStake(State.verifiedStakeAddress||null),RankingBoard.refresh(!0),this.playBtn.disabled=!1,void 0!==UI&&UI.updateHUD&&UI.updateHUD()}},AudioSys=(()=>{let e=null;const t=(t,a,s,i,o=null)=>{if(State.muted||!e)return;const r=e.createOscillator(),n=e.createGain();r.type=a,r.frequency.setValueAtTime(t,e.currentTime),o&&r.frequency.exponentialRampToValueAtTime(o,e.currentTime+s),n.gain.setValueAtTime(i,e.currentTime),n.gain.exponentialRampToValueAtTime(.01,e.currentTime+s),r.connect(n),n.connect(e.destination),r.start(),r.stop(e.currentTime+s)};return{init:()=>{e||(e=new(window.AudioContext||window.webkitAudioContext))},resume:()=>{e&&"suspended"===e.state&&e.resume()},shoot:()=>t(800,"square",.1,.1,400),hit:()=>t(200,"sawtooth",.1,.1),death:()=>t(150,"sine",.3,.2,50),ui:()=>t(1200,"sine",.05,.05),error:()=>t(100,"square",.2,.1),win:()=>{t(400,"sine",.2,.2),setTimeout(()=>t(600,"sine",.4,.2),200)},lose:()=>{t(300,"sawtooth",.5,.2,50)}}})(),getCost=e=>Math.floor(C.UPG_COST_BASE*Math.pow(C.UPG_SCALE,e-1)),formatNum=e=>Math.floor(e),formatTime=e=>{const t=Math.max(0,Math.floor(e||0)),a=Math.floor(t/60),s=t%60;return`${String(a).padStart(2,"0")}:${String(s).padStart(2,"0")}`},getDifficultyMultiplier=()=>{const e=State.timeSurvived<300?.8:1;return 1+.02*State.timeSurvived*e*.7};function traverseMeshes(e,t){e.traverse(e=>{e.isMesh&&t(e)})}class GameObject{constructor(e){this.mesh=e,this.active=!1,scene.add(e),e.visible=!1}spawn(e){this.mesh.position.copy(e),this.mesh.visible=!0,this.active=!0}despawn(){this.mesh.visible=!1,this.active=!1}}class Enemy extends GameObject{constructor(){const e=new THREE.Group,t=new THREE.SphereGeometry(.45,16,16),a=new THREE.MeshLambertMaterial({color:16777215,flatShading:!0}),s=new THREE.Mesh(t,a);s.castShadow=!0,s.position.set(0,.35,0),e.add(s);const i=new THREE.SphereGeometry(.1,8,8),o=new THREE.MeshBasicMaterial({color:16777215}),r=new THREE.Mesh(i,o);r.position.set(0,.45,.35),e.add(r);const n=new THREE.CapsuleGeometry(.22,.1,4,8),l=[];for(let t=1;t<=8;t++){const s=new THREE.Mesh(n,a.clone());s.castShadow=!0,s.position.set(0,.3,.35*-t);const i=1-.08*t;s.scale.set(i,i,i),e.add(s),l.push(s)}const c=new THREE.SpriteMaterial({color:0,opacity:.7}),h=new THREE.Sprite(c);h.scale.set(1,.15,1),h.position.set(0,1,0),e.add(h);const d=new THREE.SpriteMaterial({color:C.COLORS.enemy1}),m=new THREE.Sprite(d);m.scale.set(1,.15,1),m.position.set(0,1,.01),m.center.set(0,.5),h.add(m),m.position.x=-.5,super(e),this.body=s,this.eye=r,this.tail=l,this.hpBg=h,this.hpFg=m,this.segSpacing=.35,this.frozenTime=0,this.isFrozen=!1,this.baseColorHex=C.COLORS.enemy1,this.eyeBaseColorHex=C.COLORS.enemy1,this.hpBaseColorHex=C.COLORS.enemy1}init(e,t){this.type=e,this.path=t,this.pathIdx=0;const a=getDifficultyMultiplier();0===e?(this.hp=this.maxHp=30*a,this.speed=3.5,this.color=C.COLORS.enemy1,this.gold=5,this.xp=5,this.body.scale.set(1,1,1)):1===e?(this.hp=this.maxHp=15*a,this.speed=6,this.color=C.COLORS.enemy2,this.gold=7,this.xp=6,this.body.scale.set(.7,.7,1.2)):(this.hp=this.maxHp=80*a,this.speed=2,this.color=C.COLORS.enemy3,this.gold=15,this.xp=10,this.body.scale.set(1.4,1.4,1.4)),this.speed+=Math.min(3,.8*(a-1));const s=Math.min(2.2,1+.3*(a-1));this.mesh.scale.setScalar(s);const i=Math.min(.5,.1*(a-1));this.body.material?.color?.offsetHSL&&this.body.material.color.offsetHSL(i,.1,0),this.eye.material?.color?.offsetHSL&&this.eye.material.color.offsetHSL(i,.2,.1),this.hpFg.material?.color?.offsetHSL&&this.hpFg.material.color.offsetHSL(i,.1,0),this.baseColorHex=this.body.material.color.getHex(),this.eyeBaseColorHex=this.eye.material.color.getHex(),this.hpBaseColorHex=this.hpFg.material.color.getHex(),this._clearFreeze(),this.spawn(this.path[0]),this.mesh.position.x+=2*(Math.random()-.5),this.mesh.position.z+=2*(Math.random()-.5)}update(e){if(!this.active)return;if(this.frozenTime>0&&(this.frozenTime=Math.max(0,this.frozenTime-e),this.frozenTime<=0&&this.isFrozen&&this._clearFreeze()),this.frozenTime<=0&&this.pathIdx<this.path.length){const t=this.path[this.pathIdx];tmpVec.copy(t).sub(this.mesh.position),tmpVec.y=0,tmpVec.length()<.2?(this.pathIdx++,this.pathIdx>=this.path.length&&(damageCastle(this.hp),this.takeDamage(9999))):(tmpVec.normalize(),this.mesh.position.add(tmpVec.multiplyScalar(this.speed*e)),this.mesh.lookAt(t.x,this.mesh.position.y,t.z))}const t=clock.elapsedTime*this.speed*3,a=this.frozenTime>0?.2:1;if(this.body.position.y=.35+.08*Math.sin(t)*a,this.tail)for(let e=0;e<this.tail.length;e++){const s=this.tail[e],i=t-.4*e;s.position.set(.2*Math.sin(i)*a,.3,-(e+1)*this.segSpacing),s.rotation.y=.2*Math.sin(i)*a}}takeDamage(e){this.hp-=e,this.body.material.color.setHex(16777215),setTimeout(()=>{this.active&&this._refreshMaterials()},50);const t=Math.max(0,this.hp/this.maxHp);this.hpFg.scale.x=t,UI.spawnFloatingText(Math.round(e),this.mesh.position),this.hp<=0&&this.die()}die(){this._clearFreeze(),AudioSys.death(),spawnParticles(this.mesh.position,this.color,10),this.despawn(),returnToPool(pools.enemies,active.enemies,this),State.enemiesAlive--,this.hp>-9e3&&(addGold(this.gold),addXP(this.xp)),UI.updateHUD()}applyFreeze(e){this.active&&(this.frozenTime=Math.max(this.frozenTime,e),this.isFrozen||(this.isFrozen=!0),this._refreshMaterials())}_clearFreeze(){this.isFrozen=!1,this.frozenTime=0,this._refreshMaterials()}_refreshMaterials(){this.isFrozen?(this.body.material.color.setHex(C.COLORS.ice),this.eye.material.color.setHex(C.COLORS.ice).multiplyScalar(1.2),this.hpFg.material.color.setHex(C.COLORS.ice)):(this.body.material.color.setHex(this.baseColorHex??this.color),this.eye.material.color.setHex(this.eyeBaseColorHex??this.color),this.hpFg.material.color.setHex(this.hpBaseColorHex??this.color))}}class Projectile extends GameObject{constructor(){const e=new THREE.SphereGeometry(.2,8,8),t=new THREE.MeshBasicMaterial({color:C.COLORS.projLight}),a=new THREE.Mesh(e,t),s=new THREE.BufferGeometry,i=new Float32Array(15);s.setAttribute("position",new THREE.BufferAttribute(i,3));const o=new THREE.LineBasicMaterial({color:C.COLORS.proj,transparent:!0,opacity:.5}),r=new THREE.Line(s,o);r.frustumCulled=!1;const n=new THREE.Group;n.add(a),scene.add(r),super(n),this.trail=r,this.trailPos=[]}fire(e,t=null){this.target=e,this.lastTargetPos=(new THREE.Vector3).copy(e.mesh.position);const a=t||(castle&&castle.userData&&castle.userData.shootOrigin?castle.userData.shootOrigin:new THREE.Vector3(0,2.5,0));this.spawn(a.clone()),AudioSys.shoot(),this.trail.visible=!0,this.trailPos=[this.mesh.position.clone(),this.mesh.position.clone()]}update(e){if(!this.active)return;let t=this.lastTargetPos;if(this.target&&this.target.active&&(t=this.target.mesh.position,t=tmpVec.copy(t).add(new THREE.Vector3(0,.5,0)),this.lastTargetPos.copy(t)),tmpVec.copy(t).sub(this.mesh.position),tmpVec.length()<.5)this.target&&this.target.active&&(this.target.takeDamage(State.damage),AudioSys.hit(),spawnParticles(this.mesh.position,C.COLORS.projLight,5),State.chainTargets>0&&chainDamage(this.target,State.chainTargets,Math.floor(.6*State.damage),4),State.explosiveRadius>0&&damageArea(this.mesh.position,Math.floor(.7*State.damage),State.explosiveRadius)),this.retire();else{tmpVec.normalize(),this.mesh.position.add(tmpVec.multiplyScalar(C.PROJ_SPEED*State.projSpeedMult*e)),this.trailPos.unshift(this.mesh.position.clone()),this.trailPos.length>5&&this.trailPos.pop();const t=this.trail.geometry.attributes.position;for(let e=0;e<this.trailPos.length;e++)t.setXYZ(e,this.trailPos[e].x,this.trailPos[e].y,this.trailPos[e].z);t.needsUpdate=!0}this.mesh.position.length()>30&&this.retire()}retire(){this.despawn(),this.trail.visible=!1,this.target=null,returnToPool(pools.projectiles,active.projectiles,this)}}class Particle extends GameObject{constructor(){const e=new THREE.PlaneGeometry(.3,.3),t=new THREE.MeshBasicMaterial({color:16777215,transparent:!0,side:THREE.DoubleSide});super(new THREE.Mesh(e,t)),this.velocity=new THREE.Vector3,this.life=0}burst(e,t){this.spawn(e),this.mesh.material.color.setHex(t),this.mesh.material.opacity=1,this.mesh.lookAt(camera.position),this.velocity.set(Math.random()-.5,Math.random()-.5,Math.random()-.5).normalize().multiplyScalar(5+5*Math.random()),this.life=.5}update(e){if(this.active){if(this.life-=e,this.life<=0)return this.despawn(),void returnToPool(pools.particles,active.particles,this);this.mesh.position.add(tmpVec.copy(this.velocity).multiplyScalar(e)),this.mesh.material.opacity=2*this.life,this.mesh.scale.setScalar(1-this.life)}}}class Laser extends GameObject{constructor(){const e=new THREE.CylinderGeometry(.12,.12,1,16,1,!0),t=new THREE.MeshBasicMaterial({color:65535,transparent:!0,opacity:.85,blending:THREE.AdditiveBlending,depthWrite:!1}),a=new THREE.Mesh(e,t),s=new THREE.CylinderGeometry(.216,.216,1,16,1,!0),i=new THREE.MeshBasicMaterial({color:65535,transparent:!0,opacity:.25,blending:THREE.AdditiveBlending,depthWrite:!1}),o=new THREE.Mesh(s,i),r=new THREE.Group;r.add(a),r.add(o),super(r),this.beam=a,this.glow=o,this.life=0,this.target=null,this.damageAcc=0,this.origin=new THREE.Vector3(0,1,0),this.dps=0}fire(e){this.target=e,this.origin=castle&&castle.userData&&castle.userData.shootOrigin?castle.userData.shootOrigin.clone():new THREE.Vector3(0,1,0),this.spawn(this.origin.clone()),this.life=C.LASER_DURATION||3,this.damageAcc=0,this.dps=State.damage*C.LASER_DMG_MULT/this.life,this._updateBeamTransform()}_updateBeamTransform(){const e=this.origin;let t=e;if(this.target&&this.target.active)t=this.target.mesh.position.clone().add(new THREE.Vector3(0,.5,0));else{const a=getNearestEnemies(C.CASTLE_RANGE*State.rangeMult,1)[0];a?(this.target=a,t=a.mesh.position.clone().add(new THREE.Vector3(0,.5,0))):t=e.clone()}const a=t.clone().sub(e),s=Math.max(.001,a.length()),i=e.clone().add(t).multiplyScalar(.5),o=new THREE.Vector3(0,1,0),r=(new THREE.Quaternion).setFromUnitVectors(o,a.normalize());this.mesh.position.copy(i),this.mesh.quaternion.copy(r),this.beam.scale.set(1,s,1),this.glow.scale.set(1,s,1)}update(e){if(!this.active)return;if(this.life-=e,this._updateBeamTransform(),this.target&&this.target.active&&(this.damageAcc+=e,this.damageAcc>=.2)){const e=Math.floor(this.damageAcc/.2),t=Math.max(1,Math.floor(.2*this.dps));for(let a=0;a<e;a++)this.target.takeDamage(t),AudioSys.hit();this.damageAcc-=.2*e}const t=Math.max(.2,.1*(C.LASER_DURATION||3)),a=this.life>t?1:Math.max(0,this.life/t);this.beam.material.opacity=.85*a,this.glow.material.opacity=.25*a,this.life<=0&&this.retire()}retire(){this.despawn(),this.target=null,returnToPool(pools.lasers,active.lasers,this)}}class Boomerang extends GameObject{constructor(){const e=new THREE.TorusGeometry(.35,.08,8,16),t=new THREE.MeshBasicMaterial({color:16753920}),a=new THREE.Mesh(e,t);a.rotation.x=Math.PI/2,super(a),this.dir=new THREE.Vector3,this.origin=new THREE.Vector3,this.traveled=0,this.maxDist=C.BOOMERANG_MAX_DIST,this.phase="out",this.hitSet=new Set,this.pierceLeft=C.BOOMERANG_PIERCE}throwTowards(e){const t=castle&&castle.userData&&castle.userData.shootOrigin?castle.userData.shootOrigin:new THREE.Vector3(0,2.5,0);this.origin.copy(t);let a=e&&e.active?e.mesh.position.clone():new THREE.Vector3(0,t.y,0);a.y=t.y,this.dir.copy(a).sub(t).normalize(),this.traveled=0,this.maxDist=C.BOOMERANG_MAX_DIST*State.rangeMult,this.phase="out",this.hitSet.clear(),this.pierceLeft=C.BOOMERANG_PIERCE,this.spawn(t.clone()),AudioSys.shoot()}update(e){if(!this.active)return;const t=C.BOOMERANG_SPEED;if("out"===this.phase){const a=t*e;this.mesh.position.addScaledVector(this.dir,a),this.traveled+=a,this.traveled>=this.maxDist&&(this.phase="return")}else{const a=tmpVec.copy(this.origin).sub(this.mesh.position).setY(0);if(a.length()<.5)return void this.retire();a.normalize(),this.mesh.position.addScaledVector(a,t*e)}for(const e of active.enemies)e.active&&!this.hitSet.has(e)&&e.mesh.position.clone().setY(this.mesh.position.y).distanceToSquared(this.mesh.position)<=C.BOOMERANG_HIT_RADIUS*C.BOOMERANG_HIT_RADIUS&&(e.takeDamage(Math.floor(.9*State.damage)),this.hitSet.add(e),spawnParticles(e.mesh.position,C.COLORS.proj,5),AudioSys.hit(),this.pierceLeft--,this.pierceLeft<=0&&"out"===this.phase&&(this.phase="return"));this.mesh.rotation.z+=10*e}retire(){this.despawn(),returnToPool(pools.boomerangs,active.boomerangs,this)}}class OrbitingDrone extends GameObject{constructor(){const e=new THREE.SphereGeometry(.25,12,12),t=new THREE.MeshBasicMaterial({color:6737151});super(new THREE.Mesh(e,t)),this.angle=Math.random()*Math.PI*2,this.radius=C.DRONE_ORBIT_RADIUS,this.fireCd=0}activate(){this.radius=C.DRONE_ORBIT_RADIUS+.5*active.drones.length,this.angle=Math.random()*Math.PI*2;const e=castle&&castle.userData&&castle.userData.shootOrigin?castle.userData.shootOrigin.y-.3:2.2,t=new THREE.Vector3(Math.cos(this.angle)*this.radius,e,Math.sin(this.angle)*this.radius);this.spawn(t),this.fireCd=.3}update(e){if(!this.active)return;this.angle+=C.DRONE_ORBIT_SPEED*e;const t=castle&&castle.userData&&castle.userData.shootOrigin?castle.userData.shootOrigin.y-.3:2.2;if(this.mesh.position.set(Math.cos(this.angle)*this.radius,t,Math.sin(this.angle)*this.radius),this.fireCd-=e,this.fireCd<=0){const e=getNearestEnemyFrom(this.mesh.position,C.DRONE_RANGE*State.rangeMult);e?(getFromPool(pools.projectiles,active.projectiles,Projectile).fire(e,this.mesh.position.clone()),this.fireCd=C.DRONE_FIRE_COOLDOWN):this.fireCd=.2}}}class OrbitingBlade extends GameObject{constructor(){const e=new THREE.TorusGeometry(.6,.08,16,28),t=new THREE.MeshBasicMaterial({color:C.COLORS.blade,transparent:!0,opacity:.85,blending:THREE.AdditiveBlending}),a=new THREE.Mesh(e,t);a.rotation.x=Math.PI/2,super(a),this.rotationOffset=0,this.angle=Math.random()*Math.PI*2,this.radius=C.BLADE_ORBIT_RADIUS,this.damageTimer=0,this.total=1,this.index=0}setFormation(e,t){this.index=e,this.total=Math.max(1,t),this.radius=C.BLADE_ORBIT_RADIUS+.5*e,this.rotationOffset=2*Math.PI*(e/this.total)}activate(e,t){this.setFormation(e,t),this.angle=Math.random()*Math.PI*2;const a=this._computePosition();this.spawn(a),this.damageTimer=0}_computePosition(){const e=this.angle+this.rotationOffset,t=castle&&castle.userData&&castle.userData.shootOrigin?castle.userData.shootOrigin.y+.1:2.4;return new THREE.Vector3(Math.cos(e)*this.radius,t,Math.sin(e)*this.radius)}update(e){if(!this.active)return;this.angle+=C.BLADE_ORBIT_SPEED*e;const t=this._computePosition();this.mesh.position.copy(t),this.mesh.rotation.z+=12*e,this.damageTimer-=e,this.damageTimer<=0&&(damageAreaPlanar(new THREE.Vector3(t.x,0,t.z),Math.max(1,Math.floor(State.damage*C.BLADE_DMG_MULT)),C.BLADE_HIT_RADIUS),this.damageTimer=C.BLADE_TICK)}retire(){this.despawn(),returnToPool(pools.blades,active.blades,this)}}class Meteor extends GameObject{constructor(){const e=new THREE.SphereGeometry(.55,16,16),t=new THREE.MeshStandardMaterial({color:C.COLORS.meteor,emissive:C.COLORS.meteor,emissiveIntensity:.8}),a=new THREE.Mesh(e,t),s=new THREE.SpriteMaterial({color:C.COLORS.meteor,transparent:!0,opacity:.6,blending:THREE.AdditiveBlending,depthWrite:!1}),i=new THREE.Sprite(s),o=new THREE.Group;i.scale.set(2.2,2.2,1),o.add(a),o.add(i),super(o),this.core=a,this.glow=i,this.velocity=new THREE.Vector3(0,-C.METEOR_SPEED,0),this.targetGround=new THREE.Vector3,this.trailTimer=0}drop(e){this.targetGround.copy(e),this.targetGround.y=0;const t=e.clone();t.y=C.METEOR_START_HEIGHT,this.velocity.set(0,-C.METEOR_SPEED,0),this.spawn(t),this.mesh.scale.setScalar(1.1),this.mesh.rotation.set(0,0,0),this.trailTimer=0,this.glow.material.opacity=.6,AudioSys.shoot()}update(e){this.active&&(this.mesh.position.addScaledVector(this.velocity,e),this.mesh.rotation.x+=6*e,this.mesh.rotation.z+=4*e,this.trailTimer-=e,this.trailTimer<=0&&(tmpVec.copy(this.mesh.position),spawnParticles(tmpVec,C.COLORS.meteor,3),this.trailTimer=C.METEOR_TRAIL_INTERVAL),this.glow.material.opacity=.4+.2*Math.sin(8*clock.elapsedTime),this.mesh.position.y<=this.targetGround.y+.2&&this._explode())}_explode(){const e=new THREE.Vector3(this.targetGround.x,0,this.targetGround.z);damageAreaPlanar(e,Math.max(1,Math.floor(State.damage*C.METEOR_DMG_MULT)),C.METEOR_RADIUS),spawnParticles(new THREE.Vector3(e.x,.4,e.z),C.COLORS.meteor,16),AudioSys.death(),this.retire()}retire(){this.despawn(),returnToPool(pools.meteors,active.meteors,this)}}class LightningStrike extends GameObject{constructor(){const e=new THREE.CylinderGeometry(.06,.14,6,12,1,!0),t=new THREE.MeshBasicMaterial({color:9528063,transparent:!0,opacity:.9,blending:THREE.AdditiveBlending,depthWrite:!1});super(new THREE.Mesh(e,t)),this.life=0}strike(e){const t=e.clone(),a=Math.max(0,e.y);t.y=Math.max(3,a+3),this.spawn(t),this.mesh.material.opacity=.9,this.mesh.scale.set(1,1,1),this.life=C.LIGHTNING_LINGER,AudioSys.hit()}update(e){this.active&&(this.life-=e,this.mesh.material.opacity=Math.max(0,this.life/C.LIGHTNING_LINGER),this.life<=0&&this.retire())}retire(){this.despawn(),returnToPool(pools.lightning,active.lightning,this)}}class IceLance extends GameObject{constructor(){const e=new THREE.CylinderGeometry(.07,.18,2.6,16),t=new THREE.MeshBasicMaterial({color:C.COLORS.ice,transparent:!0,opacity:.85,blending:THREE.AdditiveBlending,depthWrite:!1}),a=new THREE.ConeGeometry(.28,.6,16),s=new THREE.MeshBasicMaterial({color:C.COLORS.ice,transparent:!0,opacity:1,blending:THREE.AdditiveBlending,depthWrite:!1}),i=new THREE.Mesh(e,t),o=new THREE.Mesh(a,s),r=new THREE.SpriteMaterial({color:C.COLORS.ice,transparent:!0,opacity:.6,blending:THREE.AdditiveBlending,depthWrite:!1}),n=new THREE.Sprite(r),l=new THREE.Group;i.position.y=.6,o.position.y=1.6,l.add(i),l.add(o),n.scale.set(1.4,1.4,1),l.add(n),super(l),this.dir=new THREE.Vector3,this.speed=C.ICE_SPEED,this.target=null,this.life=0,this.trailTimer=0,this.quat=new THREE.Quaternion}fire(e){this.target=e;const t=castle&&castle.userData&&castle.userData.shootOrigin?castle.userData.shootOrigin.clone():new THREE.Vector3(0,2.5,0);t.y+=.4,this.spawn(t),this.life=2.5,this.trailTimer=0,this._refreshDirection(),AudioSys.hit()}_refreshDirection(){this.target&&this.target.active?(tmpVec.copy(this.target.mesh.position),tmpVec.y+=.3,tmpVec.sub(this.mesh.position),0===tmpVec.lengthSq()&&tmpVec.set(0,0,-1),tmpVec.normalize(),this.dir.copy(tmpVec)):this.dir.set(0,0,-1),this.quat.setFromUnitVectors(UNIT_Y,tmpVec2.copy(this.dir)),this.mesh.quaternion.copy(this.quat)}update(e){if(!this.active)return;this.life-=e;const t=C.ICE_RANGE*State.rangeMult*1.4;if(this.life<=0||this.mesh.position.lengthSq()>t*t)this.retire();else{if(this.target&&this.target.active){if(tmpVec2.copy(this.target.mesh.position),tmpVec2.y+=.3,tmpVec2.sub(this.mesh.position),tmpVec2.lengthSq()<=.81){const e=Math.max(1,Math.floor(State.damage*C.ICE_DMG_MULT));return this.target.takeDamage(e),this.target.applyFreeze(C.ICE_FREEZE_TIME),spawnParticles(this.target.mesh.position.clone(),C.COLORS.ice,10),AudioSys.hit(),void this.retire()}tmpVec2.normalize(),this.dir.lerp(tmpVec2,.55),this.dir.normalize(),this.quat.setFromUnitVectors(UNIT_Y,tmpVec2.copy(this.dir)),this.mesh.quaternion.copy(this.quat)}this.mesh.position.addScaledVector(this.dir,this.speed*e),this.trailTimer-=e,this.trailTimer<=0&&(spawnParticles(this.mesh.position.clone(),C.COLORS.ice,3),this.trailTimer=.05)}}retire(){this.despawn(),this.target=null,returnToPool(pools.ice,active.ice,this)}}function getFromPool(e,t,a){let s=e.length>0?e.pop():new a;return t.push(s),s}function returnToPool(e,t,a){const s=t.indexOf(a);s>-1&&t.splice(s,1),e.push(a)}function spawnParticles(e,t,a){"low"===State.quality&&(a=Math.floor(a/2));for(let s=0;s<a;s++)getFromPool(pools.particles,active.particles,Particle).burst(e,t)}function getNearestEnemies(e,t){const a=e*e,s=[];for(const e of active.enemies){const t=e.mesh.position.lengthSq();t<=a&&s.push({e:e,d2:t})}s.sort((e,t)=>e.d2-t.d2);const i=[];for(let e=0;e<Math.min(t,s.length);e++)i.push(s[e].e);return i}function getNearestEnemyFrom(e,t){let a=null,s=t*t;for(const t of active.enemies){if(!t.active)continue;const i=t.mesh.position.distanceToSquared(e);i<s&&(s=i,a=t)}return a}function damageArea(e,t,a){const s=a*a;for(const a of active.enemies)a.active&&a.mesh.position.distanceToSquared(e)<=s&&a.takeDamage(t);spawnParticles(e,C.COLORS.projLight,10)}function damageAreaPlanar(e,t,a){const s=a*a;for(const a of active.enemies){if(!a.active)continue;const i=a.mesh.position.x-e.x,o=a.mesh.position.z-e.z;i*i+o*o<=s&&a.takeDamage(t)}spawnParticles(new THREE.Vector3(e.x,.2,e.z),C.COLORS.meteor,8)}function chainDamage(e,t,a,s=4){const i=new Set;let o=e;i.add(o);for(let e=0;e<t;e++){let e=null,t=1/0;for(const a of active.enemies){if(!a.active||i.has(a))continue;const r=a.mesh.position.distanceToSquared(o.mesh.position);r<t&&r<=s*s&&(t=r,e=a)}if(!e)break;e.takeDamage(a),spawnParticles(e.mesh.position,C.COLORS.proj,6),i.add(e),o=e}}const POWERUPS=[{id:"dmg",name:"Sharpened Arrows",desc:"+25% Damage",apply:()=>{State.dmgMult*=1.25,updateStats()}},{id:"firerate",name:"Haste",desc:"-10% Fire Cooldown",apply:()=>{State.fireRateMult*=.9}},{id:"range",name:"Longbow",desc:"+20% Range",apply:()=>{State.rangeMult*=1.2}},{id:"speed",name:"Ballistics",desc:"+30% Projectile Speed",apply:()=>{State.projSpeedMult*=1.3}},{id:"maxhp",name:"Fortification",desc:"+20% Max HP & heal 20%",apply:()=>{State.hpMult*=1.2,updateStats(!1,.2)}},{id:"heal",name:"First Aid",desc:"Heal 50% of missing HP",apply:()=>{const e=State.maxHp-State.hp;State.hp=Math.min(State.maxHp,State.hp+Math.floor(.5*e)),updateCastleHPBar()}},{id:"multishot",name:"Scatter Shot",desc:"+1 projectile per shot (max +3)",apply:()=>{State.multiShot=Math.min(State.multiShot+1,3)}},{id:"explosive",name:"Explosive Tips",desc:"Projectiles explode for AoE damage",apply:()=>{State.explosiveRadius=Math.min(State.explosiveRadius+1.5,4.5)}},{id:"chain",name:"Chain Lightning",desc:"Shots chain to +2 enemies",apply:()=>{State.chainTargets=Math.min(State.chainTargets+2,6)}},{id:"laser",name:"Laser Array",desc:"Unlock +1 auto laser (max 3). Fires every 1.2s dealing heavy damage.",apply:()=>{State.laserCount=Math.min((State.laserCount||0)+1,3)}},{id:"boomerang",name:"Boomerang",desc:"Unlock +1 auto boomerang (max 3). Orbits out and back, hitting multiple enemies.",apply:()=>{State.boomerangCount=Math.min((State.boomerangCount||0)+1,3)}},{id:"drone",name:"Orbital Drone",desc:"Deploy an orbital drone that shoots nearby enemies.",apply:()=>{spawnDrone(),State.droneCount=(State.droneCount||0)+1}},{id:"aura",name:"Flaming Aura",desc:"Burn nearby enemies around the castle. Scales with your damage upgrades.",apply:()=>{State.auraActive?(State.auraRadius=Math.min(State.auraRadius+1.5,10),createOrUpdateAuraVisual()):(State.auraActive=!0,State.auraTimer=0,createOrUpdateAuraVisual())}},{id:"blade",name:"Whirling Blades",desc:"Summon orbiting blades that slice nearby foes.",apply:()=>{State.bladeCount=Math.min((State.bladeCount||0)+1,5),syncOrbitingBlades()}},{id:"meteor",name:"Meteor Shower",desc:"Call down meteors on random enemies. Higher levels reduce cooldown.",apply:()=>{State.meteorCount=Math.min((State.meteorCount||0)+1,4),meteorTimer=0}},{id:"lightning",name:"Storm Conduit",desc:"Unleash lightning bolts that zap multiple enemies at once.",apply:()=>{State.lightningCount=Math.min((State.lightningCount||0)+1,5),lightningTimer=0}},{id:"ice",name:"Ice Lance",desc:"Launch freezing lances that stun enemies briefly.",apply:()=>{State.iceCount=Math.min((State.iceCount||0)+1,4),iceTimer=0}}];function randomChoices(e,t){const a=[...e],s=[];for(;s.length<Math.min(t,a.length);){const e=Math.floor(Math.random()*a.length);s.push(a.splice(e,1)[0])}return s}function initEngine(){renderer=new THREE.WebGLRenderer({antialias:"high"===State.quality,powerPreference:"high-performance"}),renderer.setSize(window.innerWidth,window.innerHeight),renderer.setPixelRatio(Math.min(window.devicePixelRatio,2)),"high"===State.quality&&(renderer.shadowMap.enabled=!0,renderer.shadowMap.type=THREE.PCFSoftShadowMap),document.getElementById("game-container").appendChild(renderer.domElement),scene=new THREE.Scene,scene.background=new THREE.Color(1120289),camera=new THREE.PerspectiveCamera(45,window.innerWidth/window.innerHeight,1,100),camera.position.set(20,20,20),controls=new OrbitControls(camera,renderer.domElement),controls.enableDamping=!0,controls.dampingFactor=.1,controls.maxPolarAngle=Math.PI/2.2,controls.minDistance=10,controls.maxDistance=40,controls.target.set(0,0,0);const e=new THREE.AmbientLight(16777215,.42);scene.add(e);const t=new THREE.DirectionalLight(16777215,.9);if(t.position.set(10,20,5),"high"===State.quality&&(t.castShadow=!0,t.shadow.mapSize.width=1024,t.shadow.mapSize.height=1024,t.shadow.camera.left=-15,t.shadow.camera.right=15,t.shadow.camera.top=15,t.shadow.camera.bottom=-15),scene.add(t),composer=new EffectComposer(renderer),composer.addPass(new RenderPass(scene,camera)),"high"===State.quality){const e=new UnrealBloomPass(new THREE.Vector2(window.innerWidth,window.innerHeight),1,.4,.85);e.threshold=.2,e.strength=.9,e.radius=.6,composer.addPass(e)}window.addEventListener("resize",onResize)}function createWorld(){const e=new THREE.PlaneGeometry(100,100),t=new THREE.MeshLambertMaterial({color:C.COLORS.ground}),a=new THREE.Mesh(e,t);a.rotation.x=-Math.PI/2,a.position.y=0,a.receiveShadow=!0,scene.add(a),textureLoader.load("https://threejs.org/examples/textures/terrain/grasslight-big.jpg",e=>{e.wrapS=e.wrapT=THREE.RepeatWrapping,e.repeat.set(40,40),e.anisotropy=renderer.capabilities.getMaxAnisotropy(),e.colorSpace=THREE.SRGBColorSpace,a.material.map=e,a.material.color.set(16777215),a.material.needsUpdate=!0});const s=new THREE.MeshLambertMaterial({color:C.COLORS.ground,transparent:!0,opacity:0,depthWrite:!1}),i=new THREE.BoxGeometry(8,1.05,30),o=new THREE.BoxGeometry(30,1.05,8),r=new THREE.Mesh(i,s),n=new THREE.Mesh(o,s);r.position.y=-.5,r.receiveShadow=!0,n.position.y=-.5,n.receiveShadow=!0;const l=new THREE.Mesh(new THREE.BoxGeometry(42,1.05,8),s);l.position.y=-.5,l.rotation.y=Math.PI/4,l.receiveShadow=!0;const c=new THREE.Mesh(new THREE.BoxGeometry(42,1.05,8),s);c.position.y=-.5,c.rotation.y=-Math.PI/4,c.receiveShadow=!0,scene.add(r,n,l,c),castle=new THREE.Group,scene.add(castle),loadCastleModel();for(let e=0;e<50;e++)pools.enemies.push(new Enemy);for(let e=0;e<20;e++)pools.projectiles.push(new Projectile);for(let e=0;e<50;e++)pools.particles.push(new Particle);for(let e=0;e<10;e++)pools.lasers.push(new Laser);for(let e=0;e<6;e++)pools.boomerangs.push(new Boomerang);for(let e=0;e<3;e++)pools.drones.push(new OrbitingDrone);for(let e=0;e<6;e++)pools.blades.push(new OrbitingBlade);for(let e=0;e<5;e++)pools.meteors.push(new Meteor);for(let e=0;e<8;e++)pools.lightning.push(new LightningStrike);for(let e=0;e<6;e++)pools.ice.push(new IceLance)}async function loadCastleModel(){const e=gltfLoader;try{const t=await e.loadAsync("castle.glb"),a=t.scene||t.scenes[0];a.traverse(e=>{e.isMesh&&(e.castShadow=!0,e.receiveShadow=!0,e.material&&e.material.color&&(e.userData.origColor=e.material.color.getHex()))});const s=(new THREE.Box3).setFromObject(a),i=new THREE.Vector3;s.getSize(i);const o=new THREE.Vector3;s.getCenter(o);const r=8;a.position.sub(o),a.position.y+=i.y/2*r,a.scale.setScalar(r),castle.add(a),addCastleHPBar();const n=i.y*r*.7;castle.userData.shootOrigin=new THREE.Vector3(0,n,0)}catch(e){console.warn("Failed to load castle.glb, using placeholder castle instead. If this is a CORS issue, run a local server (e.g., npx http-server).",e),buildPlaceholderCastle()}}function buildPlaceholderCastle(){for(;castle.children.length;)castle.remove(castle.children[0]);const e=new THREE.BoxGeometry(5,2,5),t=new THREE.MeshPhongMaterial({color:C.COLORS.castle}),a=new THREE.Mesh(e,t);a.position.y=1,a.castShadow=!0,a.receiveShadow=!0,a.userData.origColor=t.color.getHex(),castle.add(a);const s=new THREE.CylinderGeometry(.8,1,3,6),i=new THREE.ConeGeometry(1.2,1.5,6),o=new THREE.MeshPhongMaterial({color:2719929});[[-2.5,-2.5],[2.5,-2.5],[2.5,2.5],[-2.5,2.5]].forEach(e=>{const a=new THREE.Mesh(s,t.clone());a.position.set(e[0],1.5,e[1]),a.castShadow=!0,a.userData.origColor=a.material.color.getHex();const r=new THREE.Mesh(i,o);r.position.y=2.25,a.add(r),castle.add(a)}),addCastleHPBar(),castle.userData.shootOrigin=new THREE.Vector3(0,2.5,0)}function addCastleHPBar(){castle.hpBarRoot&&castle.hpBarRoot.parent&&castle.hpBarRoot.parent.remove(castle.hpBarRoot);const e=new THREE.PlaneGeometry(4,.5),t=new THREE.MeshBasicMaterial({color:0}),a=new THREE.Mesh(e,t);a.position.set(0,4.5,0);const s=new THREE.PlaneGeometry(3.8,.3),i=new THREE.MeshBasicMaterial({color:C.COLORS.proj});healthBarMesh=new THREE.Mesh(s,i),healthBarMesh.position.z=.01,healthBarMesh.geometry.translate(1.9,0,0),healthBarMesh.position.x=-1.9,a.add(healthBarMesh),castle.add(a),castle.hpBarRoot=a}function createOrUpdateAuraVisual(){if(castle)if(castle.userData.auraMesh){const e=castle.userData.auraMesh;e.geometry.dispose(),e.geometry=new THREE.RingGeometry(Math.max(.1,State.auraRadius-.3),State.auraRadius,64)}else{const e=Math.max(.1,State.auraRadius-.3),t=new THREE.RingGeometry(e,State.auraRadius,64),a=new THREE.MeshBasicMaterial({color:16742976,transparent:!0,opacity:.35,blending:THREE.AdditiveBlending,side:THREE.DoubleSide}),s=new THREE.Mesh(t,a);s.rotation.x=-Math.PI/2,s.position.y=.06,castle.add(s),castle.userData.auraMesh=s}}const SPAWN_RADIUS=15,DIAG=15/Math.SQRT2,PATHS=[[new THREE.Vector3(0,0,-15),new THREE.Vector3(0,0,0)],[new THREE.Vector3(0,0,15),new THREE.Vector3(0,0,0)],[new THREE.Vector3(-15,0,0),new THREE.Vector3(0,0,0)],[new THREE.Vector3(15,0,0),new THREE.Vector3(0,0,0)],[new THREE.Vector3(-DIAG,0,-DIAG),new THREE.Vector3(0,0,0)],[new THREE.Vector3(DIAG,0,-DIAG),new THREE.Vector3(0,0,0)],[new THREE.Vector3(-DIAG,0,DIAG),new THREE.Vector3(0,0,0)],[new THREE.Vector3(DIAG,0,DIAG),new THREE.Vector3(0,0,0)]];function initGame(){for(State.gold=C.BASE_GOLD,State.timeSurvived=0,State.dmgLvl=1,State.hpLvl=1,State.level=1,State.xp=0,State.xpToNext=XP.xpForLevel(1),State.dmgMult=State.nftDamageMultiplier||1,State.fireRateMult=1,State.rangeMult=1,State.projSpeedMult=1,State.hpMult=1,State.multiShot=0,State.explosiveRadius=0,State.chainTargets=0,State.laserCount=0,State.boomerangCount=0,State.droneCount=0,State.bladeCount=0,State.meteorCount=0,State.lightningCount=0,State.iceCount=0,State.powerLevels={},State.auraActive=!1,State.auraRadius=4,State.auraTickInterval=.5,State.auraTimer=0,castle&&castle.userData&&castle.userData.auraMesh&&(castle.remove(castle.userData.auraMesh),castle.userData.auraMesh.geometry?.dispose&&castle.userData.auraMesh.geometry.dispose(),castle.userData.auraMesh.material?.dispose&&castle.userData.auraMesh.material.dispose(),castle.userData.auraMesh=null),updateStats(!0),State.hp=State.maxHp,State.status="playing",spawnTimer=0,fireCooldown=0,laserTimer=0,boomerangTimer=0,meteorTimer=0,lightningTimer=0,iceTimer=0,[...active.enemies,...active.projectiles,...active.particles,...active.lasers,...active.boomerangs,...active.drones,...active.blades,...active.meteors,...active.lightning,...active.ice].forEach(e=>e.despawn()),active.enemies.length=0,active.projectiles.length=0,active.particles.length=0,active.lasers.length=0,active.boomerangs.length=0,active.drones.length=0,active.blades.length=0,active.meteors.length=0,active.lightning.length=0,active.ice.length=0;pools.enemies.length<50;)pools.enemies.push(new Enemy);UI.showScreen("hud"),UI.updateHUD(),updateCastleHPBar()}function updateStats(e=!1,t=0){State.damage=Math.floor(C.CASTLE_DMG_BASE*Math.pow(1.2,State.dmgLvl-1)*State.dmgMult);const a=State.maxHp,s=Math.floor(C.CASTLE_HP_BASE*Math.pow(1.2,State.hpLvl-1)*State.hpMult);if(State.maxHp=s,e);else if(State.hp>0&&a>0){const e=Math.max(0,s-a);State.hp=Math.min(s,State.hp+e+Math.floor(s*t))}else 0===State.hp&&(State.hp=s);updateCastleHPBar()}let spawnTimer=0;function getSpawnInterval(){return Math.max(.3,1.5-.014*State.timeSurvived)}function getEnemyWeights(){const e=State.timeSurvived;return e<20?[1,0,0]:e<40?[.7,.3,0]:e<60?[.5,.3,.2]:[.35,.35,.3]}function updateSpawner(e){"playing"===State.status&&(spawnTimer-=e,spawnTimer<=0&&(spawnEnemy(),spawnTimer=getSpawnInterval()))}function spawnEnemy(){const e=getFromPool(pools.enemies,active.enemies,Enemy);State.enemiesAlive++;const t=Math.floor(Math.random()*PATHS.length),a=getEnemyWeights(),s=Math.random();let i=0,o=0;for(let e=0;e<3;e++)if((o+=a[e])>=s){i=e;break}e.init(i,PATHS[t]),UI.updateHUD()}let fireCooldown=0,laserTimer=0,boomerangTimer=0,meteorTimer=0,lightningTimer=0,iceTimer=0;function updateCombat(e){fireCooldown-=e;const t=C.CASTLE_RANGE*State.rangeMult;State.bladeCount>0&&active.blades.length<State.bladeCount&&syncOrbitingBlades();const a=active.enemies.filter(e=>e.active);let s=null,i=t*t;for(const e of a){const t=e.mesh.position.lengthSq();t<i&&(i=t,s=e)}if(s&&fireCooldown<=0){const e=getNearestEnemies(t,Math.max(1,1+(State.multiShot||0)));for(const t of e)getFromPool(pools.projectiles,active.projectiles,Projectile).fire(t);fireCooldown=C.CASTLE_FIRE_RATE*State.fireRateMult,gsap.to(castle.scale,{y:.95,duration:.05,yoyo:!0,repeat:1})}if(State.laserCount>0&&(laserTimer-=e,laserTimer<=0)&&(getNearestEnemies(t,State.laserCount).forEach(e=>{getFromPool(pools.lasers,active.lasers,Laser).fire(e)}),laserTimer=C.LASER_COOLDOWN),State.boomerangCount>0&&(boomerangTimer-=e,boomerangTimer<=0)&&(getNearestEnemies(1.1*t,Math.max(1,State.boomerangCount)).forEach(e=>{getFromPool(pools.boomerangs,active.boomerangs,Boomerang).throwTowards(e)}),boomerangTimer=C.BOOMERANG_COOLDOWN),State.meteorCount>0&&(meteorTimer-=e,meteorTimer<=0))if(a.length){randomChoices(a,Math.min(State.meteorCount,a.length)).forEach(e=>{getFromPool(pools.meteors,active.meteors,Meteor).drop(e.mesh.position.clone())});const e=State.meteorCount;meteorTimer=Math.max(1.2,C.METEOR_COOLDOWN-.5*(e-1))}else meteorTimer=.4;if(State.lightningCount>0&&(lightningTimer-=e,lightningTimer<=0))if(a.length){randomChoices(a,Math.min(State.lightningCount,a.length)).forEach(e=>{const t=e.mesh.position.clone(),a=Math.max(1,Math.floor(State.damage*C.LIGHTNING_DMG_MULT));e.takeDamage(a),damageAreaPlanar(new THREE.Vector3(t.x,0,t.z),Math.max(1,Math.floor(.5*a)),C.LIGHTNING_SPLASH_RADIUS),getFromPool(pools.lightning,active.lightning,LightningStrike).strike(t)});const e=State.lightningCount;lightningTimer=Math.max(1.5,C.LIGHTNING_COOLDOWN-.6*(e-1))}else lightningTimer=.4;if(State.iceCount>0&&(iceTimer-=e,iceTimer<=0))if(a.length){randomChoices(a,Math.min(State.iceCount,a.length)).forEach(e=>{getFromPool(pools.ice,active.ice,IceLance).fire(e)});const e=State.iceCount;iceTimer=Math.max(1.4,C.ICE_COOLDOWN-.35*(e-1))}else iceTimer=.5;State.auraActive&&(State.auraTimer-=e,State.auraTimer<=0)&&(damageAreaPlanar(castle&&castle.position?new THREE.Vector3(castle.position.x,0,castle.position.z):new THREE.Vector3(0,0,0),Math.max(1,Math.floor(State.damage*C.AURA_DMG_MULT)),State.auraRadius),State.auraTimer=State.auraTickInterval)}function syncOrbitingBlades(){const e=State.bladeCount||0;for(;active.blades.length>e;){const e=active.blades[active.blades.length-1];e&&e.retire()}for(let t=active.blades.length;t<e;t++)getFromPool(pools.blades,active.blades,OrbitingBlade).activate(t,e);active.blades.forEach((t,a)=>t.setFormation(a,e))}function damageCastle(e){"over"!==State.status&&(State.hp=Math.max(0,State.hp-e),updateCastleHPBar(),gsap.to(camera.position,{x:camera.position.x+(Math.random()-.5),y:camera.position.y+(Math.random()-.5),duration:.05,yoyo:!0,repeat:3}),traverseMeshes(castle,e=>{e.material&&e.material.color&&e!==healthBarMesh&&e.parent!==castle.hpBarRoot&&(e.userData.origColor||(e.userData.origColor=e.material.color.getHex()),e.material.color.setHex(C.COLORS.castleHurt))}),setTimeout(()=>{traverseMeshes(castle,e=>{e.userData.origColor&&e.material&&e.material.color&&e.material.color.setHex(e.userData.origColor)})},100),AudioSys.lose(),State.hp<=0&&gameOver())}function addGold(e){State.gold+=e,UI.updateHUD()}function updateCastleHPBar(){const e=State.hp/State.maxHp;if(healthBarMesh){healthBarMesh.scale.x=Math.max(.001,e);const t=Math.max(0,Math.min(.3,.3*e));healthBarMesh.material.color.setHSL(t,1,.5)}UI.updateHUD()}function addXP(e){for(State.xp+=e;State.xp>=State.xpToNext;)State.xp-=State.xpToNext,State.level++,State.xpToNext=XP.xpForLevel(State.level),triggerLevelUp();UI.updateHUD()}let prevStatusForLevelUp="playing";function triggerLevelUp(){prevStatusForLevelUp=State.status,State.status="levelup";const e=document.getElementById("levelup-screen"),t=document.getElementById("powerup-options");t.innerHTML="",randomChoices(POWERUPS,3).forEach(a=>{const s=document.createElement("button");s.className="powerup-btn pointer-events-auto";const i=State.powerLevels&&State.powerLevels[a.id]||0;s.innerHTML=`<div class="title">${a.name} <span class="lvl">Lv.${i}</span></div><div class="desc">${a.desc}</div>`,s.onclick=()=>{AudioSys.ui(),a.apply(),State.powerLevels[a.id]=(State.powerLevels[a.id]||0)+1,e.classList.add("hidden"),State.status="playing",UI.updateHUD()},t.appendChild(s)}),e.classList.remove("hidden")}function gameOver(){State.status="over",isNaN(State.timeSurvived)||(State.bestTime=Math.max(State.bestTime||0,State.timeSurvived||0),localStorage.setItem("cg_best_time",String(State.bestTime))),UI.showScreen("defeat"),RankingBoard.submitScore(State.timeSurvived)}const UI={els:{gold:document.getElementById("gold-display"),time:document.getElementById("time-display"),diff:document.getElementById("diff-display"),buff:document.getElementById("buff-display"),enemies:document.getElementById("enemy-count"),hpText:document.getElementById("hp-text"),hpBar:document.getElementById("hp-bar-fill"),dmgLvl:document.getElementById("dmg-lvl"),dmgCost:document.getElementById("dmg-cost"),hpLvl:document.getElementById("hp-lvl"),hpCost:document.getElementById("hp-cost"),repCost:document.getElementById("repair-cost"),floatContainer:document.getElementById("floating-text-layer"),muteBtn:document.getElementById("btn-mute"),xpFill:document.getElementById("xp-bar-fill"),xpText:document.getElementById("xp-text"),levelNum:document.getElementById("level-num")},init:()=>{const e=document.getElementById("btn-play");e.onclick=()=>{e.disabled||(AudioSys.init(),AudioSys.ui(),initGame())},document.getElementById("btn-upg-dmg").onclick=()=>UI.buyUpgrade("dmg"),document.getElementById("btn-upg-hp").onclick=()=>UI.buyUpgrade("hp"),document.getElementById("btn-repair").onclick=UI.buyRepair,document.getElementById("btn-pause").onclick=UI.togglePause,document.getElementById("btn-resume").onclick=UI.togglePause;const t=()=>{UI.showScreen("start"),AudioSys.ui()};document.getElementById("btn-restart").onclick=t,document.getElementById("btn-restart-pause").onclick=()=>{UI.togglePause(),t()},UI.els.muteBtn.onclick=()=>{State.muted=!State.muted,localStorage.setItem("cg_muted",State.muted),UI.updateMuteIcon(),AudioSys.ui(),State.muted||AudioSys.resume()},UI.updateMuteIcon(),document.querySelectorAll("#quality-toggle .toggle-opt").forEach(e=>{e.dataset.q===State.quality?e.classList.add("active"):e.classList.remove("active"),e.onclick=()=>{e.dataset.q!==State.quality&&(State.quality=e.dataset.q,localStorage.setItem("cg_quality",State.quality),location.reload())}}),RankingBoard.init(),AccessGate.init()},updateMuteIcon:()=>{UI.els.muteBtn.textContent=State.muted?"üîá":"üîä"},updateHUD:()=>{if(UI.els.gold.textContent=State.gold,UI.els.time.textContent=formatTime(State.timeSurvived),UI.els.diff.textContent=`${getDifficultyMultiplier().toFixed(1)}x`,UI.els.buff){const e=Math.max(0,Math.round(Math.max(0,100*(State.nftDamageMultiplier-1))));UI.els.buff.textContent=`+${e}%`}UI.els.enemies.textContent=State.enemiesAlive,UI.els.hpText.textContent=`${formatNum(State.hp)}/${State.maxHp}`,UI.els.hpBar.style.width=State.hp/State.maxHp*100+"%",UI.els.dmgLvl.textContent=State.dmgLvl;const e=getCost(State.dmgLvl);UI.els.dmgCost.textContent=e+"g",document.getElementById("btn-upg-dmg").disabled=State.gold<e||"over"===State.status,UI.els.hpLvl.textContent=State.hpLvl;const t=getCost(State.hpLvl);UI.els.hpCost.textContent=t+"g",document.getElementById("btn-upg-hp").disabled=State.gold<t||"over"===State.status;const a=State.maxHp-State.hp,s=Math.ceil(a*C.REPAIR_COST_PER_HP);UI.els.repCost.textContent=a>0?s+"g":"Full",document.getElementById("btn-repair").disabled=State.gold<s||a<=0||"over"===State.status,UI.els.levelNum.textContent=State.level;const i=Math.min(1,State.xp/State.xpToNext);UI.els.xpFill.style.width=100*i+"%",UI.els.xpText.textContent=`${State.xp}/${State.xpToNext}`},buyUpgrade:e=>{const t="dmg"===e?State.dmgLvl:State.hpLvl,a=getCost(t);State.gold>=a?(State.gold-=a,"dmg"===e?State.dmgLvl++:State.hpLvl++,updateStats(),UI.updateHUD(),AudioSys.ui(),UI.spawnFloatingText("UPGRADED!",new THREE.Vector3(0,5,0),!0)):AudioSys.error()},buyRepair:()=>{const e=State.maxHp-State.hp;if(e<=0)return;const t=Math.ceil(e*C.REPAIR_COST_PER_HP);State.gold>=t?(State.gold-=t,State.hp=State.maxHp,updateCastleHPBar(),UI.updateHUD(),AudioSys.ui(),spawnParticles(new THREE.Vector3(0,2,0),C.COLORS.projLight,15)):AudioSys.error()},showScreen:e=>{if(["start-screen","hud","pause-screen","gameover-screen"].forEach(e=>document.getElementById(e).classList.add("hidden")),"start"===e){document.getElementById("start-screen").classList.remove("hidden");const e=document.getElementById("best-time");e&&(e.textContent=`Best: ${formatTime(State.bestTime||0)}`),RankingBoard.setActiveStake(State.verifiedStakeAddress||null),RankingBoard.refresh()}if("hud"===e&&document.getElementById("hud").classList.remove("hidden"),"pause"===e&&document.getElementById("pause-screen").classList.remove("hidden"),"defeat"===e){const e=document.getElementById("gameover-screen");e.classList.remove("hidden"),e.className="overlay pointer-events-auto defeat-screen",document.getElementById("go-title").textContent="DEFEAT";const t=formatTime(State.timeSurvived),a=formatTime(State.bestTime||0);document.getElementById("go-stats").textContent=`You survived ${t}. Best: ${a}.`}},togglePause:()=>{"over"!==State.status&&"start"!==State.status&&(AudioSys.ui(),"paused"===State.status?(State.status="playing",document.getElementById("pause-screen").classList.add("hidden")):(State.status="paused",document.getElementById("pause-screen").classList.remove("hidden")))},spawnFloatingText:(e,t,a=!1)=>{const s=document.createElement("div");s.className="floating-text"+(a?" crit":""),s.textContent=e,UI.els.floatContainer.appendChild(s),tmpVec.copy(t),tmpVec.project(camera);const i=(.5*tmpVec.x+.5)*window.innerWidth,o=(-.5*tmpVec.y+.5)*window.innerHeight;s.style.left=i+"px",s.style.top=o+"px",setTimeout(()=>s.remove(),800)}};function onResize(){camera.aspect=window.innerWidth/window.innerHeight,camera.updateProjectionMatrix(),renderer.setSize(window.innerWidth,window.innerHeight),composer.setSize(window.innerWidth,window.innerHeight)}function animate(){requestAnimationFrame(animate);const e=Math.min(clock.getDelta(),.1);if(controls.update(),"playing"===State.status){if(scene.rotation.y+=.05*e,castle&&castle.userData&&castle.userData.auraMesh){const e=castle.userData.auraMesh;e.material.opacity=.25+.25*(.5+.5*Math.sin(4*clock.elapsedTime));const t=1+.02*Math.sin(3*clock.elapsedTime);e.scale.set(t,1,t)}castle&&castle.hpBarRoot&&castle.hpBarRoot.lookAt(camera.position),State.timeSurvived+=e,UI.updateHUD(),updateSpawner(e),updateCombat(e),active.enemies.forEach(t=>t.update(e)),active.projectiles.forEach(t=>t.update(e)),active.particles.forEach(t=>t.update(e)),active.lasers.forEach(t=>t.update(e)),active.boomerangs.forEach(t=>t.update(e)),active.drones.forEach(t=>t.update(e)),active.blades.forEach(t=>t.update(e)),active.meteors.forEach(t=>t.update(e)),active.lightning.forEach(t=>t.update(e)),active.ice.forEach(t=>t.update(e))}else"levelup"!==State.status&&"paused"!==State.status&&"over"!==State.status||castle&&castle.hpBarRoot&&castle.hpBarRoot.lookAt(camera.position);"high"===State.quality?composer.render():renderer.render(scene,camera)}function spawnDrone(){getFromPool(pools.drones,active.drones,OrbitingDrone).activate()}function setupPreloader(){const e=document.getElementById("preload-screen"),t=document.getElementById("preload-bar"),a=document.getElementById("preload-text");loadingManager.onStart=()=>{t&&(t.style.width="0%"),a&&(a.textContent="Loading... 0%")},loadingManager.onProgress=(e,s,i)=>{const o=i?Math.floor(s/i*100):100;t&&(t.style.width=o+"%"),a&&(a.textContent=`Loading... ${o}%`)},loadingManager.onError=e=>{console.warn("Asset failed to load:",e)},loadingManager.onLoad=()=>{e&&e.classList.add("hidden"),UI.showScreen("start")}}setupPreloader(),initEngine(),createWorld(),UI.init(),animate()</script>